name: repo-sunsetter
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # File an issue with the corresponding archival checklist based on maturity model tier
  file-archival-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch maturity model tier from code.json
        run: |
          # Install jq if not already installed
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # Validate JSON file
          if ! jq empty code.json 2>/dev/null; then
            echo "âŒ Invalid JSON file"
            exit 1
          fi

          # Extract values from JSON
          TIER=$(jq -r '.maturityModelTier' code.json)
          echo "TIER=$TIER" >> $GITHUB_ENV
          echo "âœ… Maturity Model Tier: $TIER"

      - name: Download checklist file based on tier
        run: |
          FILE_URL=""
          DESTINATION_PATH="checklist.md"

          if [ "$TIER" == "0" ] || [ "$TIER" == "1" ]; then
            FILE_URL="https://raw.githubusercontent.com/natalialuzuriaga/ospo-guide/main/.github/checklist.md"
          elif [ "$TIER" == "2" ] || [ "$TIER" == "3" ] || [ "$TIER" == "4" ]; then
            FILE_URL="https://raw.githubusercontent.com/natalialuzuriaga/ospo-guide/main/.github/checklist.md"
          else
            echo "âŒ Unknown tier: $TIER"
            exit 1
          fi

          # Download file
          echo "ðŸ“¥ Downloading file from $FILE_URL..."
          wget -q --show-progress -O "$DESTINATION_PATH" "$FILE_URL"

          # Verify download
          if [ -f "$DESTINATION_PATH" ]; then
            echo "âœ… File downloaded successfully"
            ls -lh "$DESTINATION_PATH"
          else
            echo "âŒ Download failed"
            exit 1
          fi

      - name: Create archival checklist issue on the repository
        uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          filename: ./checklist.md

  # Update repository metadata to reflect archival status
  update-code-json:
    runs-on: ubuntu-latest
    name: Update code.json using archival mode
    steps:
        - name: Checkout Repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Update code.json using archival mode
          uses: DSACMS/automated-codejson-generator@main
          with:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            BRANCH: "main"
            SKIP_PR: "false"
            ARCHIVE: "true"
  
  update-readme:
    runs-on: ubuntu-latest
    name: Update README.md using archival mode
    steps:
        - name: Checkout Repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Create a branch
          run: |
            git checkout -b archive-notice-update
        - name: Add archival notice to README.md
          run: |
            ARCHIVE_TEXT="> [!IMPORTANT]\n> This project is now archived and no longer actively maintained. It has been archived to retain its contents for reference. Feel free to explore and fork the repository, but please note that updates or support will not be provided."

            awk -v notice="$ARCHIVE_TEXT" '
            /^# / && !found {
              print $0
              print notice
              found=1
              next
            }
            {print}' README.md > temp_readme.md
            mv temp_readme.md README.md

        - name: Commit changes
          run: |
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add README.md
            git commit -m "docs: add archive notice to README"

        - name: Push branch
          run: |
            git push origin archive-notice-update
            git checkout main

        - name: Create Pull Request
          uses: peter-evans/create-pull-request@v6
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
            branch: archive-notice-update
            title: "ðŸ“¦ Add Archive Notice to README"
            body: |
              ## Description
              This PR adds an archive notice to the README to inform users that this project is no longer actively maintained.
              
              ## Changes
              - Added archive notice banner to README.md
              - Includes clear information about repository status
              
            labels: archive
            commit-message: "docs: add archive notice to README"
            author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>